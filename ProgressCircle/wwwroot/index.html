<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Progress Tracker</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    input, button {
      margin: 0.2rem 0;
      padding: 0.4rem;
      box-sizing: border-box;
      width: 100%;
    }
    .diagram {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 5px;
    }
    .bar {
      position: relative;
      height: 20px;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .fill {
      height: 100%;
      background: #4caf50;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
      z-index: 1;
    }
    .overflow-fill {
      position: absolute;
      height: 100%;
      background: #2196f3;
      border-radius: 10px;
      top: 0;
      left: 0;
      z-index: 2;
      pointer-events: none;
    }
    .small { font-size: 0.8em; color: #666; }

    /* –î–ª—è –∏–Ω–ø—É—Ç–æ–≤ –∏ –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–≥—Ä–∞–º–º */
    .inputs-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .inputs-row input {
      flex: 1 1 80px;
      width: auto;
    }
    .inputs-row button {
      width: 4.5rem;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

  <h1>üìà Progress Tracker</h1>

  <h3>Create new diagram</h3>
  <div>
    <input id="name" placeholder="Name" />
    <input id="description" placeholder="Description" />
    <input id="target" type="number" placeholder="Target minutes" />
    <button onclick="createDiagram()">Create</button>
  </div>

  <h3>Diagrams</h3>
  <div id="list">Loading...</div>

  <script>
    let diagrams = [];

    function formatDisplayTime(totalMinutes) {
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      if (m === 0) return `${h}hrs`;
      return `${h}hrs ${m}min`;
    }

    async function fetchDiagrams() {
      const res = await fetch('/diagrams');
      diagrams = await res.json();
      renderDiagrams();
    }

    function renderDiagrams() {
      const list = document.getElementById('list');
      list.innerHTML = '';

      diagrams.forEach(d => {
        const percentRaw = (d.accumulatedMinutes / d.targetMinutes) * 100;
        const percentBase = Math.min(100, percentRaw);
        const percentOverflow = percentRaw > 100 ? percentRaw - 100 : 0;

        const container = document.createElement('div');
        container.className = 'diagram';

        container.innerHTML = `
          <strong>${d.name}</strong><br/>
          <span class="small">${d.description}</span><br/>
          <div class="bar">
            <div class="fill" style="width:${percentBase}%"></div>
            ${percentOverflow > 0 ? `<div class="overflow-fill" style="width:${percentOverflow}%"></div>` : ''}
          </div>
          <div>${formatDisplayTime(d.accumulatedMinutes)} / ${formatDisplayTime(d.targetMinutes)} (${percentRaw.toFixed(0)}%)</div>
          <div class="inputs-row">
            <input placeholder="AccessKey" id="key-${d.name}" />
            <input type="number" min="0" max="9999" placeholder="Add hours" id="add-hours-${d.name}" maxlength="4" />
            <input type="number" min="0" max="59" placeholder="Add minutes" id="add-minutes-${d.name}" maxlength="2" />
            <button onclick="updateDiagram('${d.name}')">Add</button>
            <button onclick="deleteDiagram('${d.name}')" style="background:#f44336;color:#fff;">Del</button>
          </div>
        `;

        list.appendChild(container);
      });
    }

    function validateInput(input, max) {
      if (input === '' || isNaN(input)) return 0;
      let val = parseInt(input);
      if (val < 0) val = 0;
      if (val > max) val = max;
      return val;
    }

    async function createDiagram() {
      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const targetRaw = document.getElementById('target').value;

      const target = validateInput(targetRaw, 100000); // –¥–æ–ø—É—Å–∫ –±–æ–ª—å—à–æ–π, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ª–∏—à–Ω–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

      if (!name || !description || target <= 0) {
        alert('Please fill all fields with valid data.');
        return;
      }

      const res = await fetch('/diagrams', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, targetMinutes: target })
      });

      const result = await res.json();
      if (res.ok) {
        alert('Created! AccessKey: ' + result.accessKey);
        fetchDiagrams();
      } else {
        alert(result.detail || 'Error creating diagram');
      }
    }

    async function updateDiagram(name) {
      const accessKey = document.getElementById('key-' + name).value.trim();
      const addHoursRaw = document.getElementById(`add-hours-${name}`).value;
      const addMinutesRaw = document.getElementById(`add-minutes-${name}`).value;

      const addHours = validateInput(addHoursRaw, 9999);
      const addMinutes = validateInput(addMinutesRaw, 59);
      const minutes = addHours * 60 + addMinutes;

      if (!accessKey) {
        alert('AccessKey required');
        return;
      }
      if (minutes === 0) {
        alert('Add hours or minutes must be greater than zero');
        return;
      }

      const res = await fetch('/diagrams', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, accumulatedMinutes: minutes, accessKey })
      });

      const result = await res.json();
      if (res.ok) {
        alert('Updated!');
        fetchDiagrams();
      } else {
        alert(result.detail || 'Error updating diagram');
      }
    }

    async function deleteDiagram(name) {
      if (!confirm(`Delete diagram "${name}"? This action cannot be undone.`)) return;

      const accessKey = document.getElementById('key-' + name).value.trim();
      if (!accessKey) {
        alert('AccessKey required to delete');
        return;
      }

      const res = await fetch('/diagrams', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, accessKey })
      });

      const result = await res.json();
      if (res.ok) {
        alert('Deleted!');
        fetchDiagrams();
      } else {
        alert(result.detail || 'Error deleting diagram');
      }
    }

    fetchDiagrams();
  </script>

</body>
</html>
